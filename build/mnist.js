/// <reference path="./all.ts" />
var fs_1 = require('fs');
var path_1 = require('path');
var dataPath = './digits', digitsPerFile = 3000, numberOfTrainings = 50000, imageWidth = 28, imageHeight = 28;
var MnistData = (function () {
    function MnistData(numberOfTrainingToParse, numberOfTestingToParse) {
        if (numberOfTrainingToParse === void 0) { numberOfTrainingToParse = 20; }
        if (numberOfTestingToParse === void 0) { numberOfTestingToParse = 1; }
        this.numberOfTrainingToParse = numberOfTrainingToParse;
        this.numberOfTestingToParse = numberOfTestingToParse;
        var trainings = [], testing, labels;
        for (var i = 0; i < numberOfTrainingToParse; i++) {
            trainings.push(JSON.parse(fs_1.readFileSync(path_1.join(__dirname, dataPath, "training_" + i + ".json")).toString()));
        }
        testing = JSON.parse(fs_1.readFileSync(path_1.join(__dirname, dataPath, "testing.json")).toString());
        labels = JSON.parse(fs_1.readFileSync(path_1.join(__dirname, dataPath, "mnist_labels.json")).toString());
        this.mnistTraining = this.parseSets(trainings, labels);
        this.mnistTesting = this.parseOneSet(testing, labels);
        this.mnistValidating = this.mnistTraining.splice(numberOfTrainings);
    }
    MnistData.draw = function (digit, context, offsetX, offsetY) {
        var imageData = context.getImageData(offsetX || 0, offsetY || 0, imageWidth, imageHeight);
        for (var i = 0; i < digit.length; i++) {
            imageData.data[i * 4] = Math.floor(digit[i] * 255);
            imageData.data[i * 4 + 1] = Math.floor(digit[i] * 255);
            imageData.data[i * 4 + 2] = Math.floor(digit[i] * 255);
        }
        context.putImageData(imageData, offsetX || 0, offsetY || 0);
    };
    MnistData.prototype.getOneTraining = function () {
        var index = Math.floor(Math.random() * this.mnistTraining.length);
        return this.mnistTraining[index];
    };
    MnistData.prototype.getOneValidating = function () {
        var index = Math.floor(Math.random() * this.mnistValidating.length);
        return this.mnistTesting[index];
    };
    MnistData.prototype.getOneTesting = function () {
        var index = Math.floor(Math.random() * this.mnistTesting.length);
        return this.mnistTesting[index];
    };
    MnistData.prototype.parseSets = function (sets, labels) {
        var digits = [];
        for (var i = 0; i < sets.length; i++) {
            digits = digits.concat(this.parseOneSet(sets[i], labels, i));
        }
        return digits;
    };
    MnistData.prototype.parseOneSet = function (set, labels, setIndex) {
        if (setIndex === void 0) { setIndex = 20; }
        var tmp = [], digits = [];
        if (set.length % (Math.pow(28, 2)) !== 0) {
            throw new Error("The length of the testing portion should be a multiple " + 3 * Math.pow(28, 2));
        }
        for (var j = 0; j < set.length; j++) {
            if (tmp.length === (Math.pow(28, 2))) {
                var index = setIndex * 3000 + Math.floor(j / (Math.pow(28, 2)));
                digits.push({
                    input: tmp,
                    output: this.convertDigitisToArray(labels[index - 1]),
                    value: labels[index - 1]
                });
                tmp = [];
            }
            tmp.push(set[j]);
        }
        if (tmp.length === (Math.pow(28, 2))) {
            var index = setIndex * 3000 + Math.floor(set.length / (Math.pow(28, 2)));
            digits.push({
                input: tmp,
                output: this.convertDigitisToArray(labels[index - 1]),
                value: labels[index - 1]
            });
            tmp = [];
        }
        return digits;
    };
    MnistData.prototype.convertDigitisToArray = function (value) {
        var res = Array.apply(null, Array(10)).map(Number.prototype.valueOf, 0);
        res.map(function (x, i) {
            if (i === value) {
                return 1;
            }
            return 0;
        });
        return res;
    };
    return MnistData;
})();
exports.MnistData = MnistData;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1uaXN0LnRzIl0sIm5hbWVzIjpbIk1uaXN0RGF0YSIsIk1uaXN0RGF0YS5jb25zdHJ1Y3RvciIsIk1uaXN0RGF0YS5kcmF3IiwiTW5pc3REYXRhLmdldE9uZVRyYWluaW5nIiwiTW5pc3REYXRhLmdldE9uZVZhbGlkYXRpbmciLCJNbmlzdERhdGEuZ2V0T25lVGVzdGluZyIsIk1uaXN0RGF0YS5wYXJzZVNldHMiLCJNbmlzdERhdGEucGFyc2VPbmVTZXQiLCJNbmlzdERhdGEuY29udmVydERpZ2l0aXNUb0FycmF5Il0sIm1hcHBpbmdzIjoiQUFBQSxpQ0FBaUM7QUFFakMsbUJBQTJCLElBQUksQ0FBQyxDQUFBO0FBQ2hDLHFCQUFtQixNQUFNLENBQUMsQ0FBQTtBQUUxQixJQUFNLFFBQVEsR0FBRyxVQUFVLEVBQ3JCLGFBQWEsR0FBRyxJQUFJLEVBQ3BCLGlCQUFpQixHQUFHLEtBQUssRUFDekIsVUFBVSxHQUFHLEVBQUUsRUFDZixXQUFXLEdBQUcsRUFBRSxDQUFDO0FBU3ZCO0lBS0VBLG1CQUNVQSx1QkFBb0NBLEVBQ3BDQSxzQkFBa0NBO1FBRDFDQyx1Q0FBNENBLEdBQTVDQSw0QkFBNENBO1FBQzVDQSxzQ0FBMENBLEdBQTFDQSwwQkFBMENBO1FBRGxDQSw0QkFBdUJBLEdBQXZCQSx1QkFBdUJBLENBQWFBO1FBQ3BDQSwyQkFBc0JBLEdBQXRCQSxzQkFBc0JBLENBQVlBO1FBRzFDQSxJQUFJQSxTQUFTQSxHQUFHQSxFQUFFQSxFQUNkQSxPQUFPQSxFQUNQQSxNQUFNQSxDQUFDQTtRQUVYQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFHQSxDQUFDQSxHQUFHQSx1QkFBdUJBLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ2xEQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxpQkFBWUEsQ0FBQ0EsV0FBSUEsQ0FBQ0EsU0FBU0EsRUFBRUEsUUFBUUEsRUFBRUEsY0FBWUEsQ0FBQ0EsVUFBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDdkdBLENBQUNBO1FBQ0RBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLGlCQUFZQSxDQUFDQSxXQUFJQSxDQUFDQSxTQUFTQSxFQUFFQSxRQUFRQSxFQUFFQSxjQUFjQSxDQUFDQSxDQUFDQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUN6RkEsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsaUJBQVlBLENBQUNBLFdBQUlBLENBQUNBLFNBQVNBLEVBQUVBLFFBQVFBLEVBQUVBLG1CQUFtQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFFN0ZBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFNBQVNBLEVBQUVBLE1BQU1BLENBQUNBLENBQUNBO1FBQ3ZEQSxJQUFJQSxDQUFDQSxZQUFZQSxHQUFHQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxPQUFPQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUN0REEsSUFBSUEsQ0FBQ0EsZUFBZUEsR0FBR0EsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxDQUFDQTtJQUN0RUEsQ0FBQ0E7SUFFTUQsY0FBSUEsR0FBWEEsVUFBYUEsS0FBZUEsRUFBRUEsT0FBaUNBLEVBQUVBLE9BQWVBLEVBQUVBLE9BQWVBO1FBRS9GRSxJQUFJQSxTQUFTQSxHQUFHQSxPQUFPQSxDQUFDQSxZQUFZQSxDQUFDQSxPQUFPQSxJQUFJQSxDQUFDQSxFQUFFQSxPQUFPQSxJQUFJQSxDQUFDQSxFQUFFQSxVQUFVQSxFQUFFQSxXQUFXQSxDQUFDQSxDQUFDQTtRQUMxRkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FB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Q0FBQ0EsR0FBR0EsQ0FBQ0EsVUFBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0E7WUFDWEEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hCQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNYQSxDQUFDQTtZQUNEQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNYQSxDQUFDQSxDQUFDQSxDQUFBQTtRQUVGQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQTtJQUViQSxDQUFDQTtJQUNIUixnQkFBQ0E7QUFBREEsQ0E5R0EsQUE4R0NBLElBQUE7QUE5R1ksaUJBQVMsWUE4R3JCLENBQUEiLCJmaWxlIjoibW5pc3QuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi9hbGwudHNcIiAvPlxuXG5pbXBvcnQge3JlYWRGaWxlU3luY30gZnJvbSAnZnMnO1xuaW1wb3J0IHtqb2lufSBmcm9tICdwYXRoJztcblxuY29uc3QgZGF0YVBhdGggPSAnLi9kaWdpdHMnLFxuICAgICAgZGlnaXRzUGVyRmlsZSA9IDMwMDAsXG4gICAgICBudW1iZXJPZlRyYWluaW5ncyA9IDUwMDAwLFxuICAgICAgaW1hZ2VXaWR0aCA9IDI4LFxuICAgICAgaW1hZ2VIZWlnaHQgPSAyODtcblxuXG5leHBvcnQgaW50ZXJmYWNlIElEaWdpdCB7XG4gIGlucHV0OiBudW1iZXJbXTsgLy9uZXJ2b3VzIGZvcm1hdC4gYXJyYXkgb2YgcGl4ZWxzXG4gIG91dHB1dDogbnVtYmVyW107IC8vbmVydm91cyBmb3JtYXQuIDEwIHplcm9zIGV4Y2VwdCB0aGUgb25lIHdoaWNoIGhhcyBpdHMgaW5kZXggZXF1YWxzIHRvIHRoZSBkaWdpdCB0aGUgdmFsdWUuXG4gIHZhbHVlOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBNbmlzdERhdGEge1xuICBwcml2YXRlIG1uaXN0VHJhaW5pbmc6IElEaWdpdFtdO1xuICBwcml2YXRlIG1uaXN0VmFsaWRhdGluZzogSURpZ2l0W107XG4gIHByaXZhdGUgbW5pc3RUZXN0aW5nOiBJRGlnaXRbXTtcbiAgXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbnVtYmVyT2ZUcmFpbmluZ1RvUGFyc2U6IG51bWJlciA9IDIwLFxuICAgIHByaXZhdGUgbnVtYmVyT2ZUZXN0aW5nVG9QYXJzZTogbnVtYmVyID0gMVxuICApIHtcbiAgICBcbiAgICBsZXQgdHJhaW5pbmdzID0gW10sXG4gICAgICAgIHRlc3RpbmcsXG4gICAgICAgIGxhYmVscztcbiAgICAgICAgXG4gICAgZm9yIChsZXQgaSA9IDAgOyBpIDwgbnVtYmVyT2ZUcmFpbmluZ1RvUGFyc2U7IGkrKykge1xuICAgICAgdHJhaW5pbmdzLnB1c2goSlNPTi5wYXJzZShyZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsIGRhdGFQYXRoLCBgdHJhaW5pbmdfJHtpfS5qc29uYCkpLnRvU3RyaW5nKCkpKTtcbiAgICB9XG4gICAgdGVzdGluZyA9IEpTT04ucGFyc2UocmVhZEZpbGVTeW5jKGpvaW4oX19kaXJuYW1lLCBkYXRhUGF0aCwgYHRlc3RpbmcuanNvbmApKS50b1N0cmluZygpKTtcbiAgICBsYWJlbHMgPSBKU09OLnBhcnNlKHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgZGF0YVBhdGgsIGBtbmlzdF9sYWJlbHMuanNvbmApKS50b1N0cmluZygpKTtcbiAgICBcbiAgICB0aGlzLm1uaXN0VHJhaW5pbmcgPSB0aGlzLnBhcnNlU2V0cyh0cmFpbmluZ3MsIGxhYmVscyk7XG4gICAgdGhpcy5tbmlzdFRlc3RpbmcgPSB0aGlzLnBhcnNlT25lU2V0KHRlc3RpbmcsIGxhYmVscyk7XG4gICAgdGhpcy5tbmlzdFZhbGlkYXRpbmcgPSB0aGlzLm1uaXN0VHJhaW5pbmcuc3BsaWNlKG51bWJlck9mVHJhaW5pbmdzKTtcbiAgfVxuICBcbiAgc3RhdGljIGRyYXcgKGRpZ2l0OiBudW1iZXJbXSwgY29udGV4dDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCBvZmZzZXRYOiBudW1iZXIsIG9mZnNldFk6IG51bWJlcikge1xuICAgIFxuICAgIHZhciBpbWFnZURhdGEgPSBjb250ZXh0LmdldEltYWdlRGF0YShvZmZzZXRYIHx8IDAsIG9mZnNldFkgfHwgMCwgaW1hZ2VXaWR0aCwgaW1hZ2VIZWlnaHQpO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlnaXQubGVuZ3RoOyBpKyspIHtcbiAgICAgIGltYWdlRGF0YS5kYXRhW2kgKiA0XSA9IE1hdGguZmxvb3IoZGlnaXRbaV0gKiAyNTUpO1xuICAgICAgaW1hZ2VEYXRhLmRhdGFbaSAqIDQgKyAxXSA9IE1hdGguZmxvb3IoZGlnaXRbaV0gKiAyNTUpO1xuICAgICAgaW1hZ2VEYXRhLmRhdGFbaSAqIDQgKyAyXSA9IE1hdGguZmxvb3IoZGlnaXRbaV0gKiAyNTUpO1xuICAgIH1cbiAgICBjb250ZXh0LnB1dEltYWdlRGF0YShpbWFnZURhdGEsIG9mZnNldFggfHwgMCwgb2Zmc2V0WSB8fCAwKTtcbiAgICBcbiAgfVxuICBcbiAgcHVibGljIGdldE9uZVRyYWluaW5nICgpOiBJRGlnaXQge1xuICAgIGxldCBpbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHRoaXMubW5pc3RUcmFpbmluZy5sZW5ndGgpO1xuICAgIHJldHVybiB0aGlzLm1uaXN0VHJhaW5pbmdbaW5kZXhdO1xuICB9XG4gIFxuICBwdWJsaWMgZ2V0T25lVmFsaWRhdGluZyAoKTogSURpZ2l0IHtcbiAgICBsZXQgaW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0aGlzLm1uaXN0VmFsaWRhdGluZy5sZW5ndGgpO1xuICAgIHJldHVybiB0aGlzLm1uaXN0VGVzdGluZ1tpbmRleF07XG4gIH1cbiAgXG4gIHB1YmxpYyBnZXRPbmVUZXN0aW5nICgpOiBJRGlnaXQge1xuICAgIGxldCBpbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHRoaXMubW5pc3RUZXN0aW5nLmxlbmd0aCk7XG4gICAgcmV0dXJuIHRoaXMubW5pc3RUZXN0aW5nW2luZGV4XTtcbiAgfVxuICBcbiAgcHJpdmF0ZSBwYXJzZVNldHMgKHNldHM6IG51bWJlcltdW10sIGxhYmVsczogbnVtYmVyW10pOiBJRGlnaXRbXSB7XG4gICAgbGV0IGRpZ2l0cyA9IFtdO1xuICAgIFxuICAgIGZvciAobGV0IGkgPSAwIDsgaSA8IHNldHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGRpZ2l0cyA9IGRpZ2l0cy5jb25jYXQodGhpcy5wYXJzZU9uZVNldChzZXRzW2ldLCBsYWJlbHMsIGkpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRpZ2l0cztcbiAgICBcbiAgfVxuICBcbiAgcHJpdmF0ZSBwYXJzZU9uZVNldCAoc2V0OiBudW1iZXJbXSwgbGFiZWxzOiBudW1iZXJbXSwgc2V0SW5kZXg6IG51bWJlciA9IDIwKTogSURpZ2l0W10ge1xuICAgIGxldCB0bXAgPSBbXSxcbiAgICAgICAgZGlnaXRzID0gW107XG4gICAgXG4gICAgaWYgKHNldC5sZW5ndGggJSAoTWF0aC5wb3coMjgsIDIpKSAhPT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgbGVuZ3RoIG9mIHRoZSB0ZXN0aW5nIHBvcnRpb24gc2hvdWxkIGJlIGEgbXVsdGlwbGUgJHszICogTWF0aC5wb3coMjgsIDIpfWApO1xuICAgIH1cbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHNldC5sZW5ndGg7IGorKykge1xuICAgICAgICBcbiAgICAgIGlmICh0bXAubGVuZ3RoID09PSAoTWF0aC5wb3coMjgsIDIpKSkge1xuICAgICAgICBsZXQgaW5kZXggPSBzZXRJbmRleCAqIDMwMDAgKyBNYXRoLmZsb29yKGogLyAoTWF0aC5wb3coMjgsIDIpKSk7XG4gICAgICAgIGRpZ2l0cy5wdXNoKHtcbiAgICAgICAgICBpbnB1dDogdG1wLFxuICAgICAgICAgIG91dHB1dDogdGhpcy5jb252ZXJ0RGlnaXRpc1RvQXJyYXkobGFiZWxzW2luZGV4IC0gMV0pLFxuICAgICAgICAgIHZhbHVlOiBsYWJlbHNbaW5kZXggLSAxXVxuICAgICAgICB9KTtcbiAgICAgICAgdG1wID0gW107XG4gICAgICB9XG4gICAgICB0bXAucHVzaChzZXRbal0pO1xuICAgICAgXG4gICAgfVxuICAgIGlmICh0bXAubGVuZ3RoID09PSAoTWF0aC5wb3coMjgsIDIpKSkge1xuICAgICAgbGV0IGluZGV4ID0gc2V0SW5kZXggKiAzMDAwICsgTWF0aC5mbG9vcihzZXQubGVuZ3RoIC8gKE1hdGgucG93KDI4LCAyKSkpO1xuICAgICAgZGlnaXRzLnB1c2goe1xuICAgICAgICBpbnB1dDogdG1wLFxuICAgICAgICBvdXRwdXQ6IHRoaXMuY29udmVydERpZ2l0aXNUb0FycmF5KGxhYmVsc1tpbmRleCAtIDFdKSxcbiAgICAgICAgdmFsdWU6IGxhYmVsc1tpbmRleCAtIDFdXG4gICAgICB9KTtcbiAgICAgIHRtcCA9IFtdO1xuICAgIH1cbiAgICByZXR1cm4gZGlnaXRzO1xuICAgIFxuICB9XG4gIFxuICBwcml2YXRlIGNvbnZlcnREaWdpdGlzVG9BcnJheSAodmFsdWU6IG51bWJlcik6IG51bWJlcltdIHtcbiAgICBcbiAgICBsZXQgcmVzID0gQXJyYXkuYXBwbHkobnVsbCwgQXJyYXkoMTApKS5tYXAoTnVtYmVyLnByb3RvdHlwZS52YWx1ZU9mLDApO1xuICAgIFxuICAgIHJlcy5tYXAoKHgsIGkpID0+IHtcbiAgICAgIGlmIChpID09PSB2YWx1ZSkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICAgIH1cbiAgICAgIHJldHVybiAwO1xuICAgIH0pXG4gICAgXG4gICAgcmV0dXJuIHJlcztcbiAgICBcbiAgfVxufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==