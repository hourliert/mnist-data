/// <reference path="./all.ts" />
var fs_1 = require('fs');
var path_1 = require('path');
var dataPath = './digits', digitsPerFile = 3000, numberOfTrainings = 50000, imageWidth = 28, imageHeight = 28;
var MnistData = (function () {
    function MnistData(numberOfTrainingToParse, numberOfTestingToParse) {
        if (numberOfTrainingToParse === void 0) { numberOfTrainingToParse = 20; }
        if (numberOfTestingToParse === void 0) { numberOfTestingToParse = 1; }
        this.numberOfTrainingToParse = numberOfTrainingToParse;
        this.numberOfTestingToParse = numberOfTestingToParse;
        var trainings = [], testing, labels;
        for (var i = 0; i < numberOfTrainingToParse; i++) {
            trainings.push(JSON.parse(fs_1.readFileSync(path_1.join(__dirname, dataPath, "training_" + i + ".json")).toString()));
        }
        testing = JSON.parse(fs_1.readFileSync(path_1.join(__dirname, dataPath, "testing.json")).toString());
        labels = JSON.parse(fs_1.readFileSync(path_1.join(__dirname, dataPath, "mnist_labels.json")).toString());
        this.mnistTraining = this.parseSets(trainings, labels);
        this.mnistTesting = this.parseOneSet(testing, labels);
        this.mnistValidating = this.mnistTraining.splice(numberOfTrainings);
    }
    Object.defineProperty(MnistData.prototype, "training", {
        get: function () {
            return this.mnistTraining;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MnistData.prototype, "validating", {
        get: function () {
            return this.mnistValidating;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MnistData.prototype, "testing", {
        get: function () {
            return this.mnistTesting;
        },
        enumerable: true,
        configurable: true
    });
    MnistData.draw = function (digit, context, offsetX, offsetY) {
        var imageData = context.getImageData(offsetX || 0, offsetY || 0, imageWidth, imageHeight);
        for (var i = 0; i < digit.length; i++) {
            imageData.data[i * 4] = Math.floor(digit[i] * 255);
            imageData.data[i * 4 + 1] = Math.floor(digit[i] * 255);
            imageData.data[i * 4 + 2] = Math.floor(digit[i] * 255);
        }
        context.putImageData(imageData, offsetX || 0, offsetY || 0);
    };
    MnistData.prototype.getOneTraining = function () {
        var index = Math.floor(Math.random() * this.mnistTraining.length);
        return this.mnistTraining[index];
    };
    MnistData.prototype.getOneValidating = function () {
        var index = Math.floor(Math.random() * this.mnistValidating.length);
        return this.mnistTesting[index];
    };
    MnistData.prototype.getOneTesting = function () {
        var index = Math.floor(Math.random() * this.mnistTesting.length);
        return this.mnistTesting[index];
    };
    MnistData.prototype.parseSets = function (sets, labels) {
        var digits = [];
        for (var i = 0; i < sets.length; i++) {
            digits = digits.concat(this.parseOneSet(sets[i], labels, i));
        }
        return digits;
    };
    MnistData.prototype.parseOneSet = function (set, labels, setIndex) {
        if (setIndex === void 0) { setIndex = 20; }
        var tmp = [], digits = [];
        if (set.length % (Math.pow(28, 2)) !== 0) {
            throw new Error("The length of the testing portion should be a multiple " + 3 * Math.pow(28, 2));
        }
        for (var j = 0; j < set.length; j++) {
            if (tmp.length === (Math.pow(28, 2))) {
                var index = setIndex * 3000 + Math.floor(j / (Math.pow(28, 2)));
                digits.push({
                    input: tmp,
                    output: this.convertDigitisToArray(labels[index - 1]),
                    value: labels[index - 1]
                });
                tmp = [];
            }
            tmp.push(set[j]);
        }
        if (tmp.length === (Math.pow(28, 2))) {
            var index = setIndex * 3000 + Math.floor(set.length / (Math.pow(28, 2)));
            digits.push({
                input: tmp,
                output: this.convertDigitisToArray(labels[index - 1]),
                value: labels[index - 1]
            });
            tmp = [];
        }
        return digits;
    };
    MnistData.prototype.convertDigitisToArray = function (value) {
        var res = Array.apply(null, Array(10)).map(Number.prototype.valueOf, 0);
        res.map(function (x, i) {
            if (i === value) {
                return 1;
            }
            return 0;
        });
        return res;
    };
    return MnistData;
})();
exports.MnistData = MnistData;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1uaXN0LnRzIl0sIm5hbWVzIjpbIk1uaXN0RGF0YSIsIk1uaXN0RGF0YS5jb25zdHJ1Y3RvciIsIk1uaXN0RGF0YS50cmFpbmluZyIsIk1uaXN0RGF0YS52YWxpZGF0aW5nIiwiTW5pc3REYXRhLnRlc3RpbmciLCJNbmlzdERhdGEuZHJhdyIsIk1uaXN0RGF0YS5nZXRPbmVUcmFpbmluZyIsIk1uaXN0RGF0YS5nZXRPbmVWYWxpZGF0aW5nIiwiTW5pc3REYXRhLmdldE9uZVRlc3RpbmciLCJNbmlzdERhdGEucGFyc2VTZXRzIiwiTW5pc3REYXRhLnBhcnNlT25lU2V0IiwiTW5pc3REYXRhLmNvbnZlcnREaWdpdGlzVG9BcnJheSJdLCJtYXBwaW5ncyI6IkFBQUEsaUNBQWlDO0FBRWpDLG1CQUEyQixJQUFJLENBQUMsQ0FBQTtBQUNoQyxxQkFBbUIsTUFBTSxDQUFDLENBQUE7QUFFMUIsSUFBTSxRQUFRLEdBQUcsVUFBVSxFQUNyQixhQUFhLEdBQUcsSUFBSSxFQUNwQixpQkFBaUIsR0FBRyxLQUFLLEVBQ3pCLFVBQVUsR0FBRyxFQUFFLEVBQ2YsV0FBVyxHQUFHLEVBQUUsQ0FBQztBQVN2QjtJQUtFQSxtQkFDVUEsdUJBQW9DQSxFQUNwQ0Esc0JBQWtDQTtRQUQxQ0MsdUNBQTRDQSxHQUE1Q0EsNEJBQTRDQTtRQUM1Q0Esc0NBQTBDQSxHQUExQ0EsMEJBQTBDQTtRQURsQ0EsNEJBQXVCQSxHQUF2QkEsdUJBQXVCQSxDQUFhQTtRQUNwQ0EsMkJBQXNCQSxHQUF0QkEsc0JBQXNCQSxDQUFZQTtRQUcxQ0EsSUFBSUEsU0FBU0EsR0FBR0EsRUFBRUEsRUFDZEEsT0FBT0EsRUFDUEEsTUFBTUEsQ0FBQ0E7UUFFWEEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBR0EsQ0FBQ0EsR0FBR0EsdUJBQXVCQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUNsREEsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsaUJBQVlBLENBQUNBLFdBQUlBLENBQUNBLFNBQVNBLEVBQUVBLFFBQVFBLEVBQUVBLGNBQVlBLENBQUNBLFVBQU9BLENBQUNBLENBQUNBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQ3ZHQSxDQUFDQTtRQUNEQSxPQUFPQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxpQkFBWUEsQ0FBQ0EsV0FBSUEsQ0FBQ0EsU0FBU0EsRUFBRUEsUUFBUUEsRUFBRUEsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDekZBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLGlCQUFZQSxDQUFDQSxXQUFJQSxDQUFDQSxTQUFTQSxFQUFFQSxRQUFRQSxFQUFFQSxtQkFBbUJBLENBQUNBLENBQUNBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBO1FBRTdGQSxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxTQUFTQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUN2REEsSUFBSUEsQ0FBQ0EsWUFBWUEsR0FBR0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDdERBLElBQUlBLENBQUNBLGVBQWVBLEdBQUdBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLE1BQU1BLENBQUNBLGlCQUFpQkEsQ0FBQ0EsQ0FBQ0E7SUFDdEVBLENBQUNBO0lBRURELHNCQUFJQSwrQkFBUUE7YUFBWkE7WUFDRUUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0E7UUFDNUJBLENBQUNBOzs7T0FBQUY7SUFFREEsc0JBQUlBLGlDQUFVQTthQUFkQTtZQUNFRyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQTtRQUM5QkEsQ0FBQ0E7OztPQUFBSDtJQUVEQSxzQkFBSUEsOEJBQU9BO2FBQVhBO1lBQ0VJLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBO1FBQzNCQSxDQUFDQTs7O09BQUFKO0lBRU1BLGNBQUlBLEdBQVhBLFVBQWFBLEtBQWVBLEVBQUVBLE9BQWlDQSxFQUFFQSxPQUFlQSxFQUFFQSxPQUFlQTtRQUUvRkssSUFBSUEsU0FBU0EsR0FBR0EsT0FBT0EsQ0FBQ0EsWUFBWUEsQ0FBQ0EsT0FBT0EsSUFBSUEsQ0FBQ0EsRUFBRUEsT0FBT0EsSUFBSUEsQ0FBQ0EsRUFBRUEsVUFBVUEsRUFBRUEsV0FBV0EsQ0FBQ0EsQ0FBQ0E7UUFDMUZBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLEtBQUtBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ3RDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNuREEsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDdkRBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3pEQSxDQUFDQTtRQUNEQSxPQUFPQSxDQUFDQSxZQUFZQSxDQUFDQSxTQUFTQSxFQUFFQSxPQUFPQSxJQUFJQSxDQUFDQSxFQUFFQSxPQUFPQSxJQUFJQSxDQUFD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Q0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hFQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtvQkFDVkEsS0FBS0EsRUFBRUEsR0FBR0E7b0JBQ1ZBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLHFCQUFxQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQ3JEQSxLQUFLQSxFQUFFQSxNQUFNQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQTtpQkFDekJBLENBQUNBLENBQUNBO2dCQUNIQSxHQUFHQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUNYQSxDQUFDQTtZQUNEQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUVuQkEsQ0FBQ0E7UUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsTUFBTUEsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDckNBLElBQUlBLEtBQUtBLEdBQUdBLFFBQVFBLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3pFQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtnQkFDVkEsS0FBS0EsRUFBRUEsR0FBR0E7Z0JBQ1ZBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLHFCQUFxQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3JEQSxLQUFLQSxFQUFFQSxNQUFNQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQTthQUN6QkEsQ0FBQ0EsQ0FBQ0E7WUFDSEEsR0FBR0EsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFDWEEsQ0FBQ0E7UUFDREEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7SUFFaEJBLENBQUNBO0lBRU9WLHlDQUFxQkEsR0FBN0JBLFVBQStCQSxLQUFhQTtRQUUxQ1csSUFBSUEsR0FBR0EsR0FBR0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsRUFBRUEsS0FBS0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsT0FBT0EsRUFBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFdkVBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLFVBQUNBLENBQUNBLEVBQUVBLENBQUNBO1lBQ1hBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBO2dCQUNoQkEsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDWEEsQ0FBQ0E7WUFDREEsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDWEEsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7UUFFRkEsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0E7SUFFYkEsQ0FBQ0E7SUFDSFgsZ0JBQUNBO0FBQURBLENBMUhBLEFBMEhDQSxJQUFBO0FBMUhZLGlCQUFTLFlBMEhyQixDQUFBIiwiZmlsZSI6Im1uaXN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4vYWxsLnRzXCIgLz5cblxuaW1wb3J0IHtyZWFkRmlsZVN5bmN9IGZyb20gJ2ZzJztcbmltcG9ydCB7am9pbn0gZnJvbSAncGF0aCc7XG5cbmNvbnN0IGRhdGFQYXRoID0gJy4vZGlnaXRzJyxcbiAgICAgIGRpZ2l0c1BlckZpbGUgPSAzMDAwLFxuICAgICAgbnVtYmVyT2ZUcmFpbmluZ3MgPSA1MDAwMCxcbiAgICAgIGltYWdlV2lkdGggPSAyOCxcbiAgICAgIGltYWdlSGVpZ2h0ID0gMjg7XG5cblxuZXhwb3J0IGludGVyZmFjZSBJRGlnaXQge1xuICBpbnB1dDogbnVtYmVyW107IC8vbmVydm91cyBmb3JtYXQuIGFycmF5IG9mIHBpeGVsc1xuICBvdXRwdXQ6IG51bWJlcltdOyAvL25lcnZvdXMgZm9ybWF0LiAxMCB6ZXJvcyBleGNlcHQgdGhlIG9uZSB3aGljaCBoYXMgaXRzIGluZGV4IGVxdWFscyB0byB0aGUgZGlnaXQgdGhlIHZhbHVlLlxuICB2YWx1ZTogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgTW5pc3REYXRhIHtcbiAgcHJpdmF0ZSBtbmlzdFRyYWluaW5nOiBJRGlnaXRbXTtcbiAgcHJpdmF0ZSBtbmlzdFZhbGlkYXRpbmc6IElEaWdpdFtdO1xuICBwcml2YXRlIG1uaXN0VGVzdGluZzogSURpZ2l0W107XG4gIFxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG51bWJlck9mVHJhaW5pbmdUb1BhcnNlOiBudW1iZXIgPSAyMCxcbiAgICBwcml2YXRlIG51bWJlck9mVGVzdGluZ1RvUGFyc2U6IG51bWJlciA9IDFcbiAgKSB7XG4gICAgXG4gICAgbGV0IHRyYWluaW5ncyA9IFtdLFxuICAgICAgICB0ZXN0aW5nLFxuICAgICAgICBsYWJlbHM7XG4gICAgICAgIFxuICAgIGZvciAobGV0IGkgPSAwIDsgaSA8IG51bWJlck9mVHJhaW5pbmdUb1BhcnNlOyBpKyspIHtcbiAgICAgIHRyYWluaW5ncy5wdXNoKEpTT04ucGFyc2UocmVhZEZpbGVTeW5jKGpvaW4oX19kaXJuYW1lLCBkYXRhUGF0aCwgYHRyYWluaW5nXyR7aX0uanNvbmApKS50b1N0cmluZygpKSk7XG4gICAgfVxuICAgIHRlc3RpbmcgPSBKU09OLnBhcnNlKHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgZGF0YVBhdGgsIGB0ZXN0aW5nLmpzb25gKSkudG9TdHJpbmcoKSk7XG4gICAgbGFiZWxzID0gSlNPTi5wYXJzZShyZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsIGRhdGFQYXRoLCBgbW5pc3RfbGFiZWxzLmpzb25gKSkudG9TdHJpbmcoKSk7XG4gICAgXG4gICAgdGhpcy5tbmlzdFRyYWluaW5nID0gdGhpcy5wYXJzZVNldHModHJhaW5pbmdzLCBsYWJlbHMpO1xuICAgIHRoaXMubW5pc3RUZXN0aW5nID0gdGhpcy5wYXJzZU9uZVNldCh0ZXN0aW5nLCBsYWJlbHMpO1xuICAgIHRoaXMubW5pc3RWYWxpZGF0aW5nID0gdGhpcy5tbmlzdFRyYWluaW5nLnNwbGljZShudW1iZXJPZlRyYWluaW5ncyk7XG4gIH1cbiAgXG4gIGdldCB0cmFpbmluZygpOiBJRGlnaXRbXSB7XG4gICAgcmV0dXJuIHRoaXMubW5pc3RUcmFpbmluZztcbiAgfVxuICBcbiAgZ2V0IHZhbGlkYXRpbmcoKTogSURpZ2l0W10ge1xuICAgIHJldHVybiB0aGlzLm1uaXN0VmFsaWRhdGluZztcbiAgfVxuICBcbiAgZ2V0IHRlc3RpbmcoKTogSURpZ2l0W10ge1xuICAgIHJldHVybiB0aGlzLm1uaXN0VGVzdGluZztcbiAgfVxuICBcbiAgc3RhdGljIGRyYXcgKGRpZ2l0OiBudW1iZXJbXSwgY29udGV4dDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCBvZmZzZXRYOiBudW1iZXIsIG9mZnNldFk6IG51bWJlcikge1xuICAgIFxuICAgIHZhciBpbWFnZURhdGEgPSBjb250ZXh0LmdldEltYWdlRGF0YShvZmZzZXRYIHx8IDAsIG9mZnNldFkgfHwgMCwgaW1hZ2VXaWR0aCwgaW1hZ2VIZWlnaHQpO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlnaXQubGVuZ3RoOyBpKyspIHtcbiAgICAgIGltYWdlRGF0YS5kYXRhW2kgKiA0XSA9IE1hdGguZmxvb3IoZGlnaXRbaV0gKiAyNTUpO1xuICAgICAgaW1hZ2VEYXRhLmRhdGFbaSAqIDQgKyAxXSA9IE1hdGguZmxvb3IoZGlnaXRbaV0gKiAyNTUpO1xuICAgICAgaW1hZ2VEYXRhLmRhdGFbaSAqIDQgKyAyXSA9IE1hdGguZmxvb3IoZGlnaXRbaV0gKiAyNTUpO1xuICAgIH1cbiAgICBjb250ZXh0LnB1dEltYWdlRGF0YShpbWFnZURhdGEsIG9mZnNldFggfHwgMCwgb2Zmc2V0WSB8fCAwKTtcbiAgICBcbiAgfVxuICBcbiAgcHVibGljIGdldE9uZVRyYWluaW5nICgpOiBJRGlnaXQge1xuICAgIGxldCBpbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHRoaXMubW5pc3RUcmFpbmluZy5sZW5ndGgpO1xuICAgIHJldHVybiB0aGlzLm1uaXN0VHJhaW5pbmdbaW5kZXhdO1xuICB9XG4gIFxuICBwdWJsaWMgZ2V0T25lVmFsaWRhdGluZyAoKTogSURpZ2l0IHtcbiAgICBsZXQgaW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0aGlzLm1uaXN0VmFsaWRhdGluZy5sZW5ndGgpO1xuICAgIHJldHVybiB0aGlzLm1uaXN0VGVzdGluZ1tpbmRleF07XG4gIH1cbiAgXG4gIHB1YmxpYyBnZXRPbmVUZXN0aW5nICgpOiBJRGlnaXQge1xuICAgIGxldCBpbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHRoaXMubW5pc3RUZXN0aW5nLmxlbmd0aCk7XG4gICAgcmV0dXJuIHRoaXMubW5pc3RUZXN0aW5nW2luZGV4XTtcbiAgfVxuICBcbiAgcHJpdmF0ZSBwYXJzZVNldHMgKHNldHM6IG51bWJlcltdW10sIGxhYmVsczogbnVtYmVyW10pOiBJRGlnaXRbXSB7XG4gICAgbGV0IGRpZ2l0cyA9IFtdO1xuICAgIFxuICAgIGZvciAobGV0IGkgPSAwIDsgaSA8IHNldHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGRpZ2l0cyA9IGRpZ2l0cy5jb25jYXQodGhpcy5wYXJzZU9uZVNldChzZXRzW2ldLCBsYWJlbHMsIGkpKTtcbiAgICB9XG4gICAgcmV0dXJuIGRpZ2l0cztcbiAgICBcbiAgfVxuICBcbiAgcHJpdmF0ZSBwYXJzZU9uZVNldCAoc2V0OiBudW1iZXJbXSwgbGFiZWxzOiBudW1iZXJbXSwgc2V0SW5kZXg6IG51bWJlciA9IDIwKTogSURpZ2l0W10ge1xuICAgIGxldCB0bXAgPSBbXSxcbiAgICAgICAgZGlnaXRzID0gW107XG4gICAgXG4gICAgaWYgKHNldC5sZW5ndGggJSAoTWF0aC5wb3coMjgsIDIpKSAhPT0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgbGVuZ3RoIG9mIHRoZSB0ZXN0aW5nIHBvcnRpb24gc2hvdWxkIGJlIGEgbXVsdGlwbGUgJHszICogTWF0aC5wb3coMjgsIDIpfWApO1xuICAgIH1cbiAgICBmb3IgKGxldCBqID0gMDsgaiA8IHNldC5sZW5ndGg7IGorKykge1xuICAgICAgICBcbiAgICAgIGlmICh0bXAubGVuZ3RoID09PSAoTWF0aC5wb3coMjgsIDIpKSkge1xuICAgICAgICBsZXQgaW5kZXggPSBzZXRJbmRleCAqIDMwMDAgKyBNYXRoLmZsb29yKGogLyAoTWF0aC5wb3coMjgsIDIpKSk7XG4gICAgICAgIGRpZ2l0cy5wdXNoKHtcbiAgICAgICAgICBpbnB1dDogdG1wLFxuICAgICAgICAgIG91dHB1dDogdGhpcy5jb252ZXJ0RGlnaXRpc1RvQXJyYXkobGFiZWxzW2luZGV4IC0gMV0pLFxuICAgICAgICAgIHZhbHVlOiBsYWJlbHNbaW5kZXggLSAxXVxuICAgICAgICB9KTtcbiAgICAgICAgdG1wID0gW107XG4gICAgICB9XG4gICAgICB0bXAucHVzaChzZXRbal0pO1xuICAgICAgXG4gICAgfVxuICAgIGlmICh0bXAubGVuZ3RoID09PSAoTWF0aC5wb3coMjgsIDIpKSkge1xuICAgICAgbGV0IGluZGV4ID0gc2V0SW5kZXggKiAzMDAwICsgTWF0aC5mbG9vcihzZXQubGVuZ3RoIC8gKE1hdGgucG93KDI4LCAyKSkpO1xuICAgICAgZGlnaXRzLnB1c2goe1xuICAgICAgICBpbnB1dDogdG1wLFxuICAgICAgICBvdXRwdXQ6IHRoaXMuY29udmVydERpZ2l0aXNUb0FycmF5KGxhYmVsc1tpbmRleCAtIDFdKSxcbiAgICAgICAgdmFsdWU6IGxhYmVsc1tpbmRleCAtIDFdXG4gICAgICB9KTtcbiAgICAgIHRtcCA9IFtdO1xuICAgIH1cbiAgICByZXR1cm4gZGlnaXRzO1xuICAgIFxuICB9XG4gIFxuICBwcml2YXRlIGNvbnZlcnREaWdpdGlzVG9BcnJheSAodmFsdWU6IG51bWJlcik6IG51bWJlcltdIHtcbiAgICBcbiAgICBsZXQgcmVzID0gQXJyYXkuYXBwbHkobnVsbCwgQXJyYXkoMTApKS5tYXAoTnVtYmVyLnByb3RvdHlwZS52YWx1ZU9mLDApO1xuICAgIFxuICAgIHJlcy5tYXAoKHgsIGkpID0+IHtcbiAgICAgIGlmIChpID09PSB2YWx1ZSkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICAgIH1cbiAgICAgIHJldHVybiAwO1xuICAgIH0pXG4gICAgXG4gICAgcmV0dXJuIHJlcztcbiAgICBcbiAgfVxufSJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==