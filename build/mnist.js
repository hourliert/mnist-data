/// <reference path="./all.ts" />
var fs_1 = require('fs');
var path_1 = require('path');
var dataPath = './digits', digitsPerFile = 3000, numberOfTrainings = 50000, imageWidth = 28, imageHeight = 28;
var MnistData = (function () {
    function MnistData(numberOfTrainingToParse, numberOfTestingToParse) {
        if (numberOfTrainingToParse === void 0) { numberOfTrainingToParse = 20; }
        if (numberOfTestingToParse === void 0) { numberOfTestingToParse = 1; }
        this.numberOfTrainingToParse = numberOfTrainingToParse;
        this.numberOfTestingToParse = numberOfTestingToParse;
        var trainings = [], testing, labels;
        for (var i = 0; i < numberOfTrainingToParse; i++) {
            trainings.push(JSON.parse(fs_1.readFileSync(path_1.join(__dirname, dataPath, "training_" + i + ".json")).toString()));
        }
        testing = JSON.parse(fs_1.readFileSync(path_1.join(__dirname, dataPath, "testing.json")).toString());
        labels = JSON.parse(fs_1.readFileSync(path_1.join(__dirname, dataPath, "mnist_labels.json")).toString());
        this.mnistTraining = this.parseSets(trainings, labels);
        this.mnistTesting = this.parseOneSet(testing, labels);
        this.mnistValidating = this.mnistTraining.splice(numberOfTrainings);
    }
    Object.defineProperty(MnistData.prototype, "training", {
        get: function () {
            return this.mnistTraining;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MnistData.prototype, "validating", {
        get: function () {
            return this.mnistValidating;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(MnistData.prototype, "testing", {
        get: function () {
            return this.mnistTesting;
        },
        enumerable: true,
        configurable: true
    });
    MnistData.draw = function (digit, context, offsetX, offsetY) {
        var imageData = context.getImageData(offsetX || 0, offsetY || 0, imageWidth, imageHeight);
        for (var i = 0; i < digit.length; i++) {
            imageData.data[i * 4] = Math.floor(digit[i] * 255);
            imageData.data[i * 4 + 1] = Math.floor(digit[i] * 255);
            imageData.data[i * 4 + 2] = Math.floor(digit[i] * 255);
        }
        context.putImageData(imageData, offsetX || 0, offsetY || 0);
    };
    MnistData.prototype.getOneTraining = function () {
        var index = Math.floor(Math.random() * this.mnistTraining.length);
        return this.mnistTraining[index];
    };
    MnistData.prototype.getOneValidating = function () {
        var index = Math.floor(Math.random() * this.mnistValidating.length);
        return this.mnistTesting[index];
    };
    MnistData.prototype.getOneTesting = function () {
        var index = Math.floor(Math.random() * this.mnistTesting.length);
        return this.mnistTesting[index];
    };
    MnistData.prototype.parseSets = function (sets, labels) {
        var digits = [];
        for (var i = 0; i < sets.length; i++) {
            digits = digits.concat(this.parseOneSet(sets[i], labels, i));
        }
        return digits;
    };
    MnistData.prototype.parseOneSet = function (set, labels, setIndex) {
        if (setIndex === void 0) { setIndex = 20; }
        var tmp = [], digits = [];
        if (set.length % (Math.pow(28, 2)) !== 0) {
            throw new Error("The length of the testing portion should be a multiple " + 3 * Math.pow(28, 2));
        }
        for (var j = 0; j < set.length; j++) {
            if (tmp.length === (Math.pow(28, 2))) {
                var index = setIndex * 3000 + Math.floor(j / (Math.pow(28, 2)));
                digits.push({
                    input: tmp,
                    output: this.convertDigitisToArray(labels[index - 1]),
                    value: labels[index - 1]
                });
                tmp = [];
            }
            tmp.push(set[j]);
        }
        if (tmp.length === (Math.pow(28, 2))) {
            var index = setIndex * 3000 + Math.floor(set.length / (Math.pow(28, 2)));
            digits.push({
                input: tmp,
                output: this.convertDigitisToArray(labels[index - 1]),
                value: labels[index - 1]
            });
            tmp = [];
        }
        return digits;
    };
    MnistData.prototype.convertDigitisToArray = function (value) {
        var res = Array.apply(null, Array(10)).map(Number.prototype.valueOf, 0);
        res = res.map(function (x, i) {
            if (i === value) {
                return 1;
            }
            return 0;
        });
        return res;
    };
    return MnistData;
})();
exports.MnistData = MnistData;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1uaXN0LnRzIl0sIm5hbWVzIjpbIk1uaXN0RGF0YSIsIk1uaXN0RGF0YS5jb25zdHJ1Y3RvciIsIk1uaXN0RGF0YS50cmFpbmluZyIsIk1uaXN0RGF0YS52YWxpZGF0aW5nIiwiTW5pc3REYXRhLnRlc3RpbmciLCJNbmlzdERhdGEuZHJhdyIsIk1uaXN0RGF0YS5nZXRPbmVUcmFpbmluZyIsIk1uaXN0RGF0YS5nZXRPbmVWYWxpZGF0aW5nIiwiTW5pc3REYXRhLmdldE9uZVRlc3RpbmciLCJNbmlzdERhdGEucGFyc2VTZXRzIiwiTW5pc3REYXRhLnBhcnNlT25lU2V0IiwiTW5pc3REYXRhLmNvbnZlcnREaWdpdGlzVG9BcnJheSJdLCJtYXBwaW5ncyI6IkFBQUEsaUNBQWlDO0FBRWpDLG1CQUEyQixJQUFJLENBQUMsQ0FBQTtBQUNoQyxxQkFBbUIsTUFBTSxDQUFDLENBQUE7QUFFMUIsSUFBTSxRQUFRLEdBQUcsVUFBVSxFQUNyQixhQUFhLEdBQUcsSUFBSSxFQUNwQixpQkFBaUIsR0FBRyxLQUFLLEVBQ3pCLFVBQVUsR0FBRyxFQUFFLEVBQ2YsV0FBVyxHQUFHLEVBQUUsQ0FBQztBQVN2QjtJQUtFQSxtQkFDVUEsdUJBQW9DQSxFQUNwQ0Esc0JBQWtDQTtRQUQxQ0MsdUNBQTRDQSxHQUE1Q0EsNEJBQTRDQTtRQUM1Q0Esc0NBQTBDQSxHQUExQ0EsMEJBQTBDQTtRQURsQ0EsNEJBQXVCQSxHQUF2QkEsdUJBQXVCQSxDQUFhQTtRQUNwQ0EsMkJBQXNCQSxHQUF0QkEsc0JBQXNCQSxDQUFZQTtRQUcxQ0EsSUFBSUEsU0FBU0EsR0FBR0EsRUFBRUEsRUFDZEEsT0FBT0EsRUFDUEEsTUFBTUEsQ0FBQ0E7UUFFWEEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBR0EsQ0FBQ0EsR0FBR0EsdUJBQXVCQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUNsREEsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsaUJBQVlBLENBQUNBLFdBQUlBLENBQUNBLFNBQVNBLEVBQUVBLFFBQVFBLEVBQUVBLGNBQVlBLENBQUNBLFVBQU9BLENBQUNBLENBQUNBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQ3ZHQSxDQUFDQTtRQUNEQSxPQUFPQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxpQkFBWUEsQ0FBQ0EsV0FBSUEsQ0FBQ0EsU0FBU0EsRUFBRUEsUUFBUUEsRUFBRUEsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDekZBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLGlCQUFZQSxDQUFDQSxXQUFJQSxDQUFDQSxTQUFTQSxFQUFFQSxRQUFRQSxFQUFFQSxtQkFBbUJBLENBQUNBLENBQUNBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBO1FBRTdGQSxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxTQUFTQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUN2REEsSUFBSUEsQ0FBQ0EsWUFBWUEsR0FBR0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDdERBLElBQUlBLENBQUNBLGVBQWVBLEdBQUdBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLE1BQU1BLENBQUNBLGlCQUFpQkEsQ0FBQ0EsQ0FBQ0E7SUFDdEVBLENBQUNBO0lBRURELHNCQUFJQSwrQkFBUUE7YUFBWkE7WUFDRUUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0E7UUFDNUJBLENBQUNBOzs7T0FBQUY7SUFFREEsc0JBQUlBLGlDQUFVQTthQUFkQTtZQUNFRyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQTtRQUM5QkEsQ0FBQ0E7OztPQUFBSDtJQUVEQSxzQkFBSUEsOEJBQU9BO2FBQVhBO1lBQ0VJLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBO1FBQzNCQSxDQUFDQTs7O09BQUFKO0lBRU1BLGNBQUlBLEdBQVhBLFVBQWFBLEtBQWVBLEVBQUVBLE9BQWlDQSxFQUFFQSxPQUFlQSxFQUFFQSxPQUFlQTtRQUUvRkssSUFBSUEsU0FBU0EsR0FBR0EsT0FBT0EsQ0FBQ0EsWUFBWUEsQ0FBQ0EsT0FBT0EsSUFBSUEsQ0FBQ0EsRUFBRUEsT0FBT0EsSUFBSUEsQ0FBQ0EsRUFBRUEsVUFBVUEsRUFBRUEsV0FBV0EsQ0FBQ0EsQ0FBQ0E7UUFDMUZBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLEtBQUtBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQ3RDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNuREEsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDdkRBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3pEQSxDQUFDQTtRQUNEQSxPQUFPQSxDQUFDQSxZQUFZQSxDQUFDQSxTQUFTQSxFQUFFQSxPQUFPQSxJQUFJQSxDQUFDQSxFQUFFQSxPQUFPQSxJQUFJQSxDQUFD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Q0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hFQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtvQkFDVkEsS0FBS0EsRUFBRUEsR0FBR0E7b0JBQ1ZBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLHFCQUFxQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQ3JEQSxLQUFLQSxFQUFFQSxNQUFNQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQTtpQkFDekJBLENBQUNBLENBQUNBO2dCQUNIQSxHQUFHQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUNYQSxDQUFDQTtZQUNEQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUVuQkEsQ0FBQ0E7UUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsTUFBTUEsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDckNBLElBQUlBLEtBQUtBLEdBQUdBLFFBQVFBLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3pFQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtnQkFDVkEsS0FBS0EsRUFBRUEsR0FBR0E7Z0JBQ1ZBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLHFCQUFxQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3JEQSxLQUFLQSxFQUFFQSxNQUFNQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQTthQUN6QkEsQ0FBQ0EsQ0FBQ0E7WUFDSEEsR0FBR0EsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFDWEEsQ0FBQ0E7UUFDREEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7SUFFaEJBLENBQUNBO0lBRU9WLHlDQUFxQkEsR0FBN0JBLFVBQStCQSxLQUFhQTtRQUUxQ1csSUFBSUEsR0FBR0EsR0FBR0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsRUFBRUEsS0FBS0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsT0FBT0EsRUFBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFdkVBLEdBQUdBLEdBQUdBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLFVBQUNBLENBQUNBLEVBQUVBLENBQUNBO1lBQ2pCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDaEJBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO1lBQ1hBLENBQUNBO1lBQ0RBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO1FBQ1hBLENBQUNBLENBQUNBLENBQUFBO1FBRUZBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBO0lBRWJBLENBQUNBO0lBQ0hYLGdCQUFDQTtBQUFEQSxDQTFIQSxBQTBIQ0EsSUFBQTtBQTFIWSxpQkFBUyxZQTBIckIsQ0FBQSIsImZpbGUiOiJtbmlzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuL2FsbC50c1wiIC8+XG5cbmltcG9ydCB7cmVhZEZpbGVTeW5jfSBmcm9tICdmcyc7XG5pbXBvcnQge2pvaW59IGZyb20gJ3BhdGgnO1xuXG5jb25zdCBkYXRhUGF0aCA9ICcuL2RpZ2l0cycsXG4gICAgICBkaWdpdHNQZXJGaWxlID0gMzAwMCxcbiAgICAgIG51bWJlck9mVHJhaW5pbmdzID0gNTAwMDAsXG4gICAgICBpbWFnZVdpZHRoID0gMjgsXG4gICAgICBpbWFnZUhlaWdodCA9IDI4O1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgSURpZ2l0IHtcbiAgaW5wdXQ6IG51bWJlcltdOyAvL25lcnZvdXMgZm9ybWF0LiBhcnJheSBvZiBwaXhlbHNcbiAgb3V0cHV0OiBudW1iZXJbXTsgLy9uZXJ2b3VzIGZvcm1hdC4gMTAgemVyb3MgZXhjZXB0IHRoZSBvbmUgd2hpY2ggaGFzIGl0cyBpbmRleCBlcXVhbHMgdG8gdGhlIGRpZ2l0IHRoZSB2YWx1ZS5cbiAgdmFsdWU6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIE1uaXN0RGF0YSB7XG4gIHByaXZhdGUgbW5pc3RUcmFpbmluZzogSURpZ2l0W107XG4gIHByaXZhdGUgbW5pc3RWYWxpZGF0aW5nOiBJRGlnaXRbXTtcbiAgcHJpdmF0ZSBtbmlzdFRlc3Rpbmc6IElEaWdpdFtdO1xuICBcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBudW1iZXJPZlRyYWluaW5nVG9QYXJzZTogbnVtYmVyID0gMjAsXG4gICAgcHJpdmF0ZSBudW1iZXJPZlRlc3RpbmdUb1BhcnNlOiBudW1iZXIgPSAxXG4gICkge1xuICAgIFxuICAgIGxldCB0cmFpbmluZ3MgPSBbXSxcbiAgICAgICAgdGVzdGluZyxcbiAgICAgICAgbGFiZWxzO1xuICAgICAgICBcbiAgICBmb3IgKGxldCBpID0gMCA7IGkgPCBudW1iZXJPZlRyYWluaW5nVG9QYXJzZTsgaSsrKSB7XG4gICAgICB0cmFpbmluZ3MucHVzaChKU09OLnBhcnNlKHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgZGF0YVBhdGgsIGB0cmFpbmluZ18ke2l9Lmpzb25gKSkudG9TdHJpbmcoKSkpO1xuICAgIH1cbiAgICB0ZXN0aW5nID0gSlNPTi5wYXJzZShyZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsIGRhdGFQYXRoLCBgdGVzdGluZy5qc29uYCkpLnRvU3RyaW5nKCkpO1xuICAgIGxhYmVscyA9IEpTT04ucGFyc2UocmVhZEZpbGVTeW5jKGpvaW4oX19kaXJuYW1lLCBkYXRhUGF0aCwgYG1uaXN0X2xhYmVscy5qc29uYCkpLnRvU3RyaW5nKCkpO1xuICAgIFxuICAgIHRoaXMubW5pc3RUcmFpbmluZyA9IHRoaXMucGFyc2VTZXRzKHRyYWluaW5ncywgbGFiZWxzKTtcbiAgICB0aGlzLm1uaXN0VGVzdGluZyA9IHRoaXMucGFyc2VPbmVTZXQodGVzdGluZywgbGFiZWxzKTtcbiAgICB0aGlzLm1uaXN0VmFsaWRhdGluZyA9IHRoaXMubW5pc3RUcmFpbmluZy5zcGxpY2UobnVtYmVyT2ZUcmFpbmluZ3MpO1xuICB9XG4gIFxuICBnZXQgdHJhaW5pbmcoKTogSURpZ2l0W10ge1xuICAgIHJldHVybiB0aGlzLm1uaXN0VHJhaW5pbmc7XG4gIH1cbiAgXG4gIGdldCB2YWxpZGF0aW5nKCk6IElEaWdpdFtdIHtcbiAgICByZXR1cm4gdGhpcy5tbmlzdFZhbGlkYXRpbmc7XG4gIH1cbiAgXG4gIGdldCB0ZXN0aW5nKCk6IElEaWdpdFtdIHtcbiAgICByZXR1cm4gdGhpcy5tbmlzdFRlc3Rpbmc7XG4gIH1cbiAgXG4gIHN0YXRpYyBkcmF3IChkaWdpdDogbnVtYmVyW10sIGNvbnRleHQ6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgb2Zmc2V0WDogbnVtYmVyLCBvZmZzZXRZOiBudW1iZXIpIHtcbiAgICBcbiAgICB2YXIgaW1hZ2VEYXRhID0gY29udGV4dC5nZXRJbWFnZURhdGEob2Zmc2V0WCB8fCAwLCBvZmZzZXRZIHx8IDAsIGltYWdlV2lkdGgsIGltYWdlSGVpZ2h0KTtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpZ2l0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBpbWFnZURhdGEuZGF0YVtpICogNF0gPSBNYXRoLmZsb29yKGRpZ2l0W2ldICogMjU1KTtcbiAgICAgIGltYWdlRGF0YS5kYXRhW2kgKiA0ICsgMV0gPSBNYXRoLmZsb29yKGRpZ2l0W2ldICogMjU1KTtcbiAgICAgIGltYWdlRGF0YS5kYXRhW2kgKiA0ICsgMl0gPSBNYXRoLmZsb29yKGRpZ2l0W2ldICogMjU1KTtcbiAgICB9XG4gICAgY29udGV4dC5wdXRJbWFnZURhdGEoaW1hZ2VEYXRhLCBvZmZzZXRYIHx8IDAsIG9mZnNldFkgfHwgMCk7XG4gICAgXG4gIH1cbiAgXG4gIHB1YmxpYyBnZXRPbmVUcmFpbmluZyAoKTogSURpZ2l0IHtcbiAgICBsZXQgaW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0aGlzLm1uaXN0VHJhaW5pbmcubGVuZ3RoKTtcbiAgICByZXR1cm4gdGhpcy5tbmlzdFRyYWluaW5nW2luZGV4XTtcbiAgfVxuICBcbiAgcHVibGljIGdldE9uZVZhbGlkYXRpbmcgKCk6IElEaWdpdCB7XG4gICAgbGV0IGluZGV4ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdGhpcy5tbmlzdFZhbGlkYXRpbmcubGVuZ3RoKTtcbiAgICByZXR1cm4gdGhpcy5tbmlzdFRlc3RpbmdbaW5kZXhdO1xuICB9XG4gIFxuICBwdWJsaWMgZ2V0T25lVGVzdGluZyAoKTogSURpZ2l0IHtcbiAgICBsZXQgaW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB0aGlzLm1uaXN0VGVzdGluZy5sZW5ndGgpO1xuICAgIHJldHVybiB0aGlzLm1uaXN0VGVzdGluZ1tpbmRleF07XG4gIH1cbiAgXG4gIHByaXZhdGUgcGFyc2VTZXRzIChzZXRzOiBudW1iZXJbXVtdLCBsYWJlbHM6IG51bWJlcltdKTogSURpZ2l0W10ge1xuICAgIGxldCBkaWdpdHMgPSBbXTtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMCA7IGkgPCBzZXRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBkaWdpdHMgPSBkaWdpdHMuY29uY2F0KHRoaXMucGFyc2VPbmVTZXQoc2V0c1tpXSwgbGFiZWxzLCBpKSk7XG4gICAgfVxuICAgIHJldHVybiBkaWdpdHM7XG4gICAgXG4gIH1cbiAgXG4gIHByaXZhdGUgcGFyc2VPbmVTZXQgKHNldDogbnVtYmVyW10sIGxhYmVsczogbnVtYmVyW10sIHNldEluZGV4OiBudW1iZXIgPSAyMCk6IElEaWdpdFtdIHtcbiAgICBsZXQgdG1wID0gW10sXG4gICAgICAgIGRpZ2l0cyA9IFtdO1xuICAgIFxuICAgIGlmIChzZXQubGVuZ3RoICUgKE1hdGgucG93KDI4LCAyKSkgIT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlIGxlbmd0aCBvZiB0aGUgdGVzdGluZyBwb3J0aW9uIHNob3VsZCBiZSBhIG11bHRpcGxlICR7MyAqIE1hdGgucG93KDI4LCAyKX1gKTtcbiAgICB9XG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCBzZXQubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgXG4gICAgICBpZiAodG1wLmxlbmd0aCA9PT0gKE1hdGgucG93KDI4LCAyKSkpIHtcbiAgICAgICAgbGV0IGluZGV4ID0gc2V0SW5kZXggKiAzMDAwICsgTWF0aC5mbG9vcihqIC8gKE1hdGgucG93KDI4LCAyKSkpO1xuICAgICAgICBkaWdpdHMucHVzaCh7XG4gICAgICAgICAgaW5wdXQ6IHRtcCxcbiAgICAgICAgICBvdXRwdXQ6IHRoaXMuY29udmVydERpZ2l0aXNUb0FycmF5KGxhYmVsc1tpbmRleCAtIDFdKSxcbiAgICAgICAgICB2YWx1ZTogbGFiZWxzW2luZGV4IC0gMV1cbiAgICAgICAgfSk7XG4gICAgICAgIHRtcCA9IFtdO1xuICAgICAgfVxuICAgICAgdG1wLnB1c2goc2V0W2pdKTtcbiAgICAgIFxuICAgIH1cbiAgICBpZiAodG1wLmxlbmd0aCA9PT0gKE1hdGgucG93KDI4LCAyKSkpIHtcbiAgICAgIGxldCBpbmRleCA9IHNldEluZGV4ICogMzAwMCArIE1hdGguZmxvb3Ioc2V0Lmxlbmd0aCAvIChNYXRoLnBvdygyOCwgMikpKTtcbiAgICAgIGRpZ2l0cy5wdXNoKHtcbiAgICAgICAgaW5wdXQ6IHRtcCxcbiAgICAgICAgb3V0cHV0OiB0aGlzLmNvbnZlcnREaWdpdGlzVG9BcnJheShsYWJlbHNbaW5kZXggLSAxXSksXG4gICAgICAgIHZhbHVlOiBsYWJlbHNbaW5kZXggLSAxXVxuICAgICAgfSk7XG4gICAgICB0bXAgPSBbXTtcbiAgICB9XG4gICAgcmV0dXJuIGRpZ2l0cztcbiAgICBcbiAgfVxuICBcbiAgcHJpdmF0ZSBjb252ZXJ0RGlnaXRpc1RvQXJyYXkgKHZhbHVlOiBudW1iZXIpOiBudW1iZXJbXSB7XG4gICAgXG4gICAgbGV0IHJlcyA9IEFycmF5LmFwcGx5KG51bGwsIEFycmF5KDEwKSkubWFwKE51bWJlci5wcm90b3R5cGUudmFsdWVPZiwwKTtcbiAgICBcbiAgICByZXMgPSByZXMubWFwKCh4LCBpKSA9PiB7XG4gICAgICBpZiAoaSA9PT0gdmFsdWUpIHtcbiAgICAgICAgcmV0dXJuIDE7XG4gICAgICB9XG4gICAgICByZXR1cm4gMDtcbiAgICB9KVxuICAgIFxuICAgIHJldHVybiByZXM7XG4gICAgXG4gIH1cbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=